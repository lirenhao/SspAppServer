# 1. 新加坡SSPAppServer接口文档

**修改记录**

| 修改人 | 修改日期   | 修改内容 | 当前版本 |
| ------ | ---------- | -------- | -------- |
| 李任昊 | 2018-10-22 | 内容修正 | v1.0.0   |
|        |            |          |          |

## 1.1. 引言

新加坡SSPAppServer后台提供APP各个功能接口供APP调用。

## 1.2. 总体方案

### 1.2.1. 设计原则
采用app端数据与appServer端分离的原则

### 1.2.2. 技术架构
数据库使用oracle，采用Spring-data-jpa数据库接口，使用fastjson对数据进行格式转换，采用Oath2.0开放授权)。

### 1.2.3. 业务说明

提供APP后台登录、交易及查询功能详细业务流程请查阅流程图

## 1.3. 接口说明

APPServer承担APP后台功能，提供登录、查询用户信息、修改用户密码、推送绑定、推送解绑、
获取商户信息、商户交易列表查询、交易信息查询、获取用户二维码、交易结果查询等接口供APP
调用。

| 业务                 | 说明                                         |
| -------------------- | -------------------------------------------- |
| 用户登录             | APP用户根据商户号、登录名、密码等信息登录APP |
| 获取用户信息         | 获取用户的详细信息                           |
| 修改用户密码         | APP用户对密码进行修改                        |
| 推送绑定             | 绑定推送时需要的用户设备信息                 |
| 推送解绑             | 解绑推送时需要的用户设备信息                 |
| 获取商户的子商户信息 | 查询商户详细信息                             |
| 商户交易列表查询     | 根据商户号和交易时间查询商户交易信息列表     |
| 交易信息查询         | 根据商户号及交易流水号查询交易信息详情       |
| 获取用户二维码       | 根据金额生成商户交易二维码                   |
| 交易结果查询         | 根据交易查询号查询结果                       |

### 1.3.1. 用户登录

- 接口功能  

    > APP用户根据商户号、登录名、密码信息登录APP

- URL  

    > [http://ip:port/oauth/token]()

- 支持格式  

    > JSON

- 请求方式  

    > POST

- 请求Header  
    | name          | value                             | 说明                             |
    | ------------- | --------------------------------- | -------------------------------- |
    | Authorization | Basic 商户号@登录名:密码          | 商户号@登录名:密码转base64字符串 |
    | Content-Type  | application/x-www-form-urlencoded |                                  |

- 请求参数  
    | 参数       | 类型   | 必填 | 说明                                    |
    | ---------- | ------ | ---- | --------------------------------------- |
    | grant_type | string | 是   | oauth2验证类型,固定值client_credentials |

- 返回字段  
    | 字段名       | 含义          | 字段类型 | 是否必填 | 备注                                  |
    | ------------ | ------------- | -------- | -------- | ------------------------------------- |
    | access_token | token信息     | string   | 是       | 用户登录成功的token信息               |
    | token_type   | token类型     | string   | 是       | token类型                             |
    | expires_in   | token过期时间 | string   | 是       | token过期时间超过该日期后需要重新登录 |
    | scope        | 访问权限      | string   | 是       | 该用户可操作的权限                    |

- 接口示例
    - 请求  
        ```
        curl http://localhost:3001/oauth/token \
        -H "Authorization: Basic Y29uZmlkZW50aWFsQXBwbGljYXRpb246dG9wU2VjcmV0" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "grant_type=client_credentials"
        ```
    - 返回  
        ```
        {
            "access_token": "1445e74f-965e-4586-9c60-afdd0bd4114d",
            "token_type": "bearer",
            "expires_in": 2591999,
            "scope": "all"
        }
        ```

### 1.3.2. 获取用户信息

- 接口功能  

    > 获取用户的详细信息

- URL  

    > [http://ip:port/user]()

- 支持格式  

    > JSON

- 请求方式  

    > GET

- 请求Header  
    | name          | value               | 说明                               |
    | ------------- | ------------------- | ---------------------------------- |
    | Authorization | bearer access_token | access_token是登录成功后返回的参数 |

- 请求参数  

    > 无

- 返回字段  
    | 字段名 | 含义 | 字段类型 | 是否必填 | 备注 |
    | ------ | ---- | -------- | -------- | ---- |
    |        |      |          |          |      |

- 接口示例
    - 请求  
        ```
        curl http://localhost:3001/user \
        -H "Authorization: bearer 1445e74f-965e-4586-9c60-afdd0bd4114d"
        ```
    - 返回  
        ```
        {
            "merNo": "100000000000666",
            "loginName": "lrh",
            "userName": "李任昊",
            "roles": "tran,user",
            "termNo": "78945612",
            "ccyType": {
                "ccyType": "156",
                "ccyName": "人民币",
                "ccyEname": "CNY",
                "ccySymbol": "￥"
            }
        }
        ```

### 1.3.3. 修改用户密码 

- 接口功能  

    > APP用户对密码进行修改

- URL  

    > [http://ip:port/user]()

- 支持格式  

    > JSON

- 请求方式  

    > GET

- 请求Header  
    | name          | value               | 说明                               |
    | ------------- | ------------------- | ---------------------------------- |
    | Authorization | bearer access_token | access_token是登录成功后返回的参数 |

- 请求参数  

    > 无

- 返回字段  
    | 字段名 | 含义 | 字段类型 | 是否必填 | 备注 |
    | ------ | ---- | -------- | -------- | ---- |
    |        |      |          |          |      |

- 接口示例
    - 请求  
        ```
        curl http://localhost:3001/user \
        -H "Authorization: bearer 1445e74f-965e-4586-9c60-afdd0bd4114d"
        ```
    - 返回  
        ```
        {
            "merNo": "100000000000666",
            "loginName": "lrh",
            "userName": "李任昊",
            "roles": "tran,user",
            "termNo": "78945612",
            "ccyType": {
                "ccyType": "156",
                "ccyName": "人民币",
                "ccyEname": "CNY",
                "ccySymbol": "￥"
            }
        }
        ```
### 1.3.4. 推送绑定
绑定推送时需要的用户设备信息
- 接口功能  

    > APP用户对密码进行修改

- URL  

    > [http://ip:port/user]()

- 支持格式  

    > JSON

- 请求方式  

    > GET

- 请求Header  
    | name          | value               | 说明                               |
    | ------------- | ------------------- | ---------------------------------- |
    | Authorization | bearer access_token | access_token是登录成功后返回的参数 |

- 请求参数  

    > 无

- 返回字段  
    | 字段名 | 含义 | 字段类型 | 是否必填 | 备注 |
    | ------ | ---- | -------- | -------- | ---- |
    |        |      |          |          |      |

- 接口示例
    - 请求  
        ```
        curl http://localhost:3001/user \
        -H "Authorization: bearer 1445e74f-965e-4586-9c60-afdd0bd4114d"
        ```
    - 返回  
        ```
        {
            "merNo": "100000000000666",
            "loginName": "lrh",
            "userName": "李任昊",
            "roles": "tran,user",
            "termNo": "78945612",
            "ccyType": {
                "ccyType": "156",
                "ccyName": "人民币",
                "ccyEname": "CNY",
                "ccySymbol": "￥"
            }
        }
        ```
### 1.3.5. 推送解绑
解绑推送时需要的用户设备信息
- 接口功能  

    > APP用户对密码进行修改

- URL  

    > [http://ip:port/user]()

- 支持格式  

    > JSON

- 请求方式  

    > GET

- 请求Header  
    | name          | value               | 说明                               |
    | ------------- | ------------------- | ---------------------------------- |
    | Authorization | bearer access_token | access_token是登录成功后返回的参数 |

- 请求参数  

    > 无

- 返回字段  
    | 字段名 | 含义 | 字段类型 | 是否必填 | 备注 |
    | ------ | ---- | -------- | -------- | ---- |
    |        |      |          |          |      |

- 接口示例
    - 请求  
        ```
        curl http://localhost:3001/user \
        -H "Authorization: bearer 1445e74f-965e-4586-9c60-afdd0bd4114d"
        ```
    - 返回  
        ```
        {
            "merNo": "100000000000666",
            "loginName": "lrh",
            "userName": "李任昊",
            "roles": "tran,user",
            "termNo": "78945612",
            "ccyType": {
                "ccyType": "156",
                "ccyName": "人民币",
                "ccyEname": "CNY",
                "ccySymbol": "￥"
            }
        }
        ```
### 1.3.6. 获取商户的子商户信息
查询商户详细信息
### 1.3.7. 商户交易列表查询

- 接口功能  

    > 根据商户号和交易时间查询商户交易信息列表

- URL  

    > [http://ip:port/tran/{merNo}]()

- 支持格式  

    > JSON

- 请求方式  

    > GET

- 请求Header  
    | name          | value               | 说明                               |
    | ------------- | ------------------- | ---------------------------------- |
    | Authorization | bearer access_token | access_token是登录成功后返回的参数 |

- 请求参数  
    | 参数  | 类型   | 必填 | 说明                |
    | ----- | ------ | ---- | ------------------- |
    | merNo | string | 是   | 商户号，组装到URL里 |

- 返回字段  
    | 字段名 | 含义 | 字段类型 | 是否必填 | 备注 |
    | ------ | ---- | -------- | -------- | ---- |
    |        |      |          |          |      |

- 接口示例
    - 请求  
        ```
        
        ```
    - 返回  
        ```
        
        ```
### 1.3.8. 交易信息查询

- 接口功能  

    > 根据商户号及交易流水号查询交易信息详情

- URL  

    > [http://ip:port/tran/{merNo}/{tranId}]()

- 支持格式  

    > JSON

- 请求方式  

    > GET

- 请求Header  
    | name          | value               | 说明                               |
    | ------------- | ------------------- | ---------------------------------- |
    | Authorization | bearer access_token | access_token是登录成功后返回的参数 |

- 请求参数  
    | 参数   | 类型   | 必填 | 说明                    |
    | ------ | ------ | ---- | ----------------------- |
    | merNo  | string | 是   | 商户号，组装到URL里     |
    | tranId | string | 是   | 交易流水号，组装到URL里 |

- 返回字段  
    | 字段名 | 含义 | 字段类型 | 是否必填 | 备注 |
    | ------ | ---- | -------- | -------- | ---- |
    |        |      |          |          |      |

- 接口示例
    - 请求  
        ```
        
        ```
    - 返回  
        ```
       
        ```
### 1.3.9. 获取用户二维码

- 接口功能  

    > 根据金额生成商户交易二维码

- URL  

    > [http://ip:port/qrCode]()

- 支持格式  

    > JSON

- 请求方式  

    > POST

- 请求Header  
    | name          | value               | 说明                               |
    | ------------- | ------------------- | ---------------------------------- |
    | Authorization | bearer access_token | access_token是登录成功后返回的参数 |

- 请求参数  
    | 参数 | 类型   | 必填 | 说明                                 |
    | ---- | ------ | ---- | ------------------------------------ |
    | amt  | string | 是   | 金额，单位是元最大精确到小数点后两位 |

- 返回字段  
    | 字段名 | 含义 | 字段类型 | 是否必填 | 备注 |
    | ------ | ---- | -------- | -------- | ---- |
    |        |      |          |          |      |

- 接口示例
    - 请求  
        ```
        curl http://localhost:3001/qrCode \
        -H "Authorization: bearer 1445e74f-965e-4586-9c60-afdd0bd4114d"
        ```
    - 返回  
        ```
        
        ```
### 1.3.10. 交易结果查询

- 接口功能  

    > 根据交易查询号查询结果

- URL  

    > [http://ip:port/qrCode/{queryNo} ]()

- 支持格式  

    > JSON

- 请求方式  

    > GET

- 请求Header  
    | name          | value               | 说明                               |
    | ------------- | ------------------- | ---------------------------------- |
    | Authorization | bearer access_token | access_token是登录成功后返回的参数 |

- 请求参数  
    | 参数    | 类型   | 必填 | 说明                          |
    | ------- | ------ | ---- | ----------------------------- |
    | queryNo | string | 是   | 付款码交易查询号，组装到URL里 |

- 返回字段  
    | 字段名 | 含义 | 字段类型 | 是否必填 | 备注 |
    | ------ | ---- | -------- | -------- | ---- |
    |        |      |          |          |      |

- 接口示例
    - 请求  
        ```
        curl http://localhost:3001/qrCode \
        -H "Authorization: bearer 1445e74f-965e-4586-9c60-afdd0bd4114d"
        ```
    - 返回  
        ```
        
        ```



#### 1.3.10.1. 获取用户信息的入参字段说明

| 字段名        | 含义           | 字段类型 | 是否必填 | 备注                                                                                           |
| ------------- | -------------- | -------- | -------- | ---------------------------------------------------------------------------------------------- |
| authorization | 验证信息       | String   | 是       | Basic 商户号@登录名：登录密码转base64字符串 例：Basic MTIzNDU2Nzg5MDEyMzQ1QGFkbWluOjExMTExMQ== |
| grant_type    | oauth2验证类型 | String   | 是       | client_credentials 固定值                                                                      |



| 字段名           | 含义         | 字段类型                                                                | 请求方式/是否必填 | 备注                                                                       |
| ---------------- | ------------ | ----------------------------------------------------------------------- | ----------------- | -------------------------------------------------------------------------- |
| user             | 获取商户信息 | OAuth2Authentication(用户登录)                                          | GetMapping/是     | 请求路径 ip:port/user                                                      |
| updatePwd/oldPwd | 修改商户密码 | token（授权信息)  oldPwd(旧密码) newPwd(新密码)                         | PutMapping/是     | ip:port/user/updatePwd?oldPwd=111111&newPwd=222222                         |
| bindPush         | 推送绑定     | token(授权信息) pushType(设备类型) deviceNo(设备ID)  platform(设备平台) | PostMapping/是    | ip：port/user/bindPush?pushType=设备类型&deviceNo=设备ID&platform=设备平台 | Post/platform 设备平台 |
| unBindPush       | 推送解绑     | token(授权信息)                                                         | DeleteMapping/是  | ip：port/user/unBindPush                                                   |
#### 1.3.10.2. 用户业务的出参字段说明
| 请求         | 出参类型 | 出参结果                                                                                               | 出参结果含义                                                                                                     |
| ------------ | -------- | ------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------- |
| 获取用户信息 | UserInfo | {"merNo": "787913470","loginName": "111111","userName": admin,"roles": 经理,"termNo": 03,"ccyType": $} | merNo->商户号 loginName->登录名 userName->用户名 passWord->用户密码 roles->角色 termNo->终端号 ccyType->交易币种 |
| 推送绑定     | UserInfo | {"merNo": "787913470","loginName": "111111","userName": admin,"roles": 经理,"termNo": 03,"ccyType": $} | merNo->商户号 loginName->登录名 userName->用户名 passWord->用户密码 roles->角色 termNo->终端号 ccyType->交易币种 |
| 修改商户密码 | boolean  | FALSE                                                                                                  | TRUE/FALSE 成功/失败                                                                                             |
| 推送解绑     | boolean  | TRUE                                                                                                   | TRUE/FALSE 成功/失败                                                                                             |
## 1.4. 交易业务
交易业务包括：获取商户信息/获取全部交易详情/获取具体交易详情
#### 1.4.0.3. 用户交易入参字段说明

| 字段名         | 含义                          | 字段类型                                          | 请求方式/是否必填 | 备注                                   |
| -------------- | ----------------------------- | ------------------------------------------------- | ----------------- | -------------------------------------- |
| subMer         | 获取商户信息                  | token(授权信息)                                   | 是/GetMapping     | ip:port/tran/subMer                    |
| merNo/tranDate | 交易单号/交易时间             | token(授权信息),merNo( 商户号),tranDate(交易时间) | 是/GetMapping     | ip:port/tran/merNo?tranDate=2018-03-15 |
| tran/merNo/id  | 通过集团商户号/id获取交易详情 | merNo(   商户号),id(流水号)                       | 是/GetMapping     | ip:port/tran/418057105/787913470       |
#### 1.4.0.4. 用户交易出参字段说明

| 请求                          | 出参类型            | 出参结果                                                                                                                                                                                                                                                                              | 出参结果含义                                                                                                                                                                                                                    |
| ----------------------------- | ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 获取商户信息                  | Map<String, String> | {"787913470": "肯德基"}                                                                                                                                                                                                                                                               | 商户号：商户中文名称                                                                                                                                                                                                            |
| 交易单号/交易时间             | List<TranInfo>      | [{"traceNo": "787913470","batchNo": D026268,"invoiceNo": 84270402,"tranAmt": 1000,"tranType":"付款","tranDate": "2018-08-01 15：20：01","channel": "pos","cardNo": "52131608646","merNo": "787913479", "termNo": "277427","authNo": "06,"rrn": "03","mcc": "5812","respCode": "200"}] | traceNo->流水号 batchNo-> 批次号 invoiceNo->票据号 tranAmt->交易金额 tranType->交易类型 tranDate->交易时间 channel->交易渠道 cardNo->卡号 merNo->商户号 termNo->终端号 authNo-> 授权号 rrn-> 参考号 mcc->mcc码 respCode->返回码 |
| 通过集团商户号/id获取交易详情 | TranInfo            | {"traceNo": "787913470","batchNo": D026268,"invoiceNo": 84270402,"tranAmt": 1000,"tranType":"付款","tranDate": "2018-08-01 15：20：01","channel": "pos","cardNo": "52131608646","merNo": "787913479", "termNo": "277427","authNo": "06,"rrn": "03","mcc": "5812","respCode": "200"}   | traceNo->流水号 batchNo-> 批次号 invoiceNo->票据号 tranAmt->交易金额 tranType->交易类型 tranDate->交易时间 channel->交易渠道 cardNo->卡号 merNo->商户号 termNo->终端号 authNo-> 授权号 rrn-> 参考号 mcc->mcc码 respCode->返回码 |

## 1.5. 二维码交易
获取用户二维码/根据交易查询号查询结果
#### 1.5.0.5. 二维码交易入参字段说明

| 字段名  | 含义           | 字段类型                              | 请求方式/是否必填 | 备注                                    |
| ------- | -------------- | ------------------------------------- | ----------------- | --------------------------------------- |
| qrCode  | 获取用户二维码 | token(授权信息),amt(交易金额)         | PostMapping/是    | ip:port/qrCode/?amt=11 amt为交易金额    |
| queryNo | 交易查询号     | token(授权信息),queryNo（交易查询号） | GetMapping/是     | ip:port/qrCode/1111  交易id获取交易详情 |
#### 1.5.0.6. 二维码交易出参字段说明
| 请求    | 出参类型            | 出参结果 | 出参结果含义 | 备注                                              |
| ------- | ------------------- | -------- | ------------ | ------------------------------------------------- |
| qrCode  | Map<String, String> | null     | 无           | ip:port/qrCode/?amt=11 amt为交易金额              |
| queryNo | Map<String, String> | null     | 无           | ip:port/qrCode/2018031559018  queryNo->交易查询号 |
#### 1.5.0.7. 详情工作流程请参考《新加坡SSPAPPServer流程图.pdf》